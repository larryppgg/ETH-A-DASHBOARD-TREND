# ETH-A Dashboard Trend

本项目为本地可运行的策略仪表盘，覆盖宏观闸门、风险矩阵与趋势智能，支持自动抓取 + 本地历史回填 + 全链路可审计回溯。

---

## 功能概览

- **总览态势层**：当前档位、动作建议、核心驱动、风险阻断一屏可读
- **证据链层**：闸门链路 + Top3 触发原因 + 风险注记
- **深度审计层**：输入字段 → 来源 → 计算 → 规则命中
- **数据与运维层**：抓取 / 校验 / 运行 / 回放流程可视化
- **AI 解读**：异步分批生成 + 全局总结（豆包 API）
- **时间轴**：历史快照回放 + 趋势曲线（含 ETH 现货）
- **预测质量层**：as-of 防时间穿越 + 漂移门 + 交易成本门

---

## 快速开始

推荐：
```bash
npm run dev
```
访问：`http://localhost:5173`

仅更新数据：
```bash
npm run fetch
```

补齐历史回测样本（让预测评估表减少 `PENDING`）：
```bash
npm run backfill -- --days 365 --step 7
```

备用方式：
```bash
bash scripts/dev.sh
```
说明：`scripts/dev.sh` 与 `npm run dev` 一致，都会启动 `scripts/server.py`（包含 AI 与历史回抓 API）。

---

## 运行流程（建议顺序）

1. **今日运行**（自动抓取 + 校验 + 计算 + 回放 + AI）
2. 若提示缺失字段：
   - 点击“自动抓取”（优先读取本地快照 `auto.json`，无需外部抓取）
   - 再点击“今日运行”
   - 若仍缺失/半衰期拦截：再点击“强制抓取”（后端实时采集并更新 `auto.json`）
3. 若外部源缺口仍存在：
   - 系统会**优先用本地历史补齐**
   - 但会执行**字段级半衰期校验**，超过半衰期不回填（防止过期数据污染）
4. 查看“运行状态”区分：
   - **运行时间（本地）**：你点击运行的时间
   - **数据时间（抓取）**：抓取时间 + 字段最新观测时间
   - **漂移门 / 成本门**：预测稳定性与执行摩擦是否允许进攻

---

## 预测质量治理（新增）

- **as-of 防护**：预测评估只允许使用 `as-of` 截止前可见样本，禁止“时间穿越”。
- **漂移门（QG）**：基于 7D 命中率偏离基线判定 `OK/WARN/FAIL`，并自动降级档位/β。
- **成本门**：结合上一次 β 估算换手成本，成本过高时自动压低有效 β。
- **发布门禁**：可信度 + 时效 + 漂移 + 成本 + AI 解释完整度联合判定。

---

## 脚本说明

- `npm run dev`：抓取 + 启动本地服务
- `npm run fetch`：仅抓取并写入 `src/data/auto.json`
- `npm run backfill -- --days 365 --step 7`：批量回抓历史并写入 `src/data/history.seed.json`
- `npm test`：运行前端规则与逻辑测试

---

## 配置说明（.env）

复制 `.env.example` → `.env`，并填写：

```
DOUBAO_API_KEY=...
DOUBAO_MODEL=...
PROXY_PRIMARY=direct
PROXY_FALLBACK=direct
DOUBAO_DIRECT=true
DOH_URL=
```

字段说明：
- `DOUBAO_API_KEY`：豆包 Key
- `DOUBAO_MODEL`：模型名（如 doubao-seed-1-8-251228）
- `DOUBAO_DIRECT`：true 表示直连豆包；false 时使用代理池
- `PROXY_PRIMARY/PROXY_FALLBACK`：代理地址或 direct
- `DOH_URL`：可选 DNS over HTTPS（如需）

> 本仓库不会保存密钥，请仅在本地 `.env` 中维护。

---

## 数据源与可靠性

自动抓取主要来自：
- FRED（宏观）
- DefiLlama（稳定币 + CEX 储备 + RWA）
- CoinGecko（市场 + 价格结构）
- Coinglass（清算）
- Farside（ETF 流入流出）
- GDELT（分发闸门事件）

**ETF 数据兜底逻辑**：
- 若 Farside 直连被 Cloudflare 拦截 → 自动回退 Jina 代理抓取
- 若直连可用 → 同时用 Jina 校验差分
- 对“Total vs 组件合计”做一致性校验并记录

**CEX 数据兜底逻辑**：
- DefiLlama CEX 缺失时 → 使用 CoinGecko 交易量代理补齐
- 会在 `errors` 中记录 fallback 信息

---

## AI 解读与全局总结（豆包）

- AI 请求异步分批发送
- 先返回先展示（无需等待全部完成）
- 新增“AI 全局总结”（对全量结果推断与预测）

提示：AI 生成失败时会保留已成功部分，并提示失败状态。

AI 超时：默认至少 5 分钟（由后端超时配置控制）。

---

## 历史与缓存策略

- 历史记录保存在浏览器 `LocalStorage`
- 历史数据会自动写入并持久化
- 时间轴支持 365 天历史滑动回放
- 字段回填遵循“本地历史优先 + 半衰期拦截”
- 覆盖矩阵展示每个字段的：观测时间 / 抓取时间 / 新鲜度
- 若需要清空历史：点击页面底部“清空历史”

---

## 常见问题

### 1. 为什么出现“字段不完整”？
- 通常是外部源短暂不可达导致关键字段缺失，或字段观测时间超过半衰期被拦截（过期但完整数据更危险）
- 建议顺序：**自动抓取（本地快照） → 今日运行 → 强制抓取（外部刷新）**

### 2. 为什么我看不到“手动输入”按钮？
- 默认是自动模式，手动输入路径已关闭（避免手工数据污染判断）。
- 若出现缺口，按“自动抓取（本地快照）→ 今日运行 → 强制抓取（外部刷新）”即可。

### 3. ETF 数据一直为 0？
- 可能是 Farside 直连受限
- 已启用 Jina 兜底抓取，建议重新运行 `npm run fetch`

### 4. 浏览器提示模块导出缺失？
- 这是缓存旧脚本导致
- 解决：**强制刷新 (Cmd+Shift+R)** 或重新打开页面

---

## 目录说明

- `src/` 前端与逻辑核心
- `scripts/collector.py` 数据抓取
- `scripts/server.py` 本地服务 + AI 代理
- `docs/specs/` 规则与设计文档

---

## 版本

- **v2.0.1**：新增总览态势层、AI 异步解读、全局 AI 总结、ETF 抓取兜底与交叉验证。

---

## License

内部私有仓库使用，不公开发布。
