<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ETH-A Dashboard Trend</title>
    <link rel="stylesheet" href="styles.css?v=20260219-1" />
  </head>
  <body>
    <div class="grid-sheen"></div>
    <div class="halo"></div>
    <div class="file-warning" id="fileWarning">
      请使用本地服务器启动（`npm run dev`），直接打开文件会导致模块加载失败。
    </div>

    <header class="masthead">
      <div>
        <div class="eyebrow">ETH-A / A 仪表盘 v2.0.1</div>
        <h1>Macro Gate · Risk Matrix · Trend Intelligence</h1>
        <p>战情级策略看板 · 全链路可审计 · 日度快照与历史趋势</p>
      </div>
      <div class="masthead-actions">
        <div class="view-toggle view-toggle-single" aria-label="视图模式">
          <span class="view-single-label">单一研究视图</span>
          <button id="viewPlainBtn" class="ghost view active view-hidden" type="button" tabindex="-1" aria-hidden="true">通俗</button>
          <button id="viewExpertBtn" class="ghost view view-hidden" type="button" tabindex="-1" aria-hidden="true">专家</button>
        </div>
        <button id="runBtn" class="cta">今日运行</button>
        <div class="last-run">Last Run: <span id="lastRun">--</span></div>
        <div class="run-status" id="runStatus">待运行</div>
      </div>
    </header>

    <main class="shell">
      <nav class="quick-nav" id="quickNav" aria-label="快速导航">
        <a class="nav-item" href="#runBar">运行</a>
        <a class="nav-item" href="#timelinePanel">时间轴</a>
        <a class="nav-item" href="#statusPanel">态势</a>
        <a class="nav-item" href="#gateAuditPanel">闸门审计</a>
        <a class="nav-item" href="#actionPanel">行动</a>
        <a class="nav-item" href="#reasonsPanel">证据</a>
        <a class="nav-item" href="#aiPanelSection">AI</a>
        <a class="nav-item" href="#trendPanel">趋势</a>
        <a class="nav-item" href="#evalPanelSection">评估</a>
        <a class="nav-item" href="#dataPanelSection">数据台</a>
        <button class="ghost nav-top" id="navTopBtn" type="button">回到顶部</button>
      </nav>

      <section class="panel run-bar stage-marker stage-decision" id="runBar" data-layout-mode="decision">
        <div class="run-bar-header">
          <div>
            <div class="run-bar-title">运行状态</div>
            <div class="run-bar-sub">抓取 → 校验 → 计算 → 回放 → AI</div>
          </div>
          <div class="run-bar-meta" id="runMetaLeft">
            <div class="run-meta">
              <span>抓取时间</span>
              <strong id="healthFreshness">--</strong>
            </div>
            <div class="run-meta">
              <span>缺失字段</span>
              <strong id="healthMissing">--</strong>
            </div>
            <div class="run-meta">
              <span>代理/网络</span>
              <strong id="healthProxy">--</strong>
            </div>
            <div class="run-meta">
              <span>AI 状态</span>
              <strong id="healthAi">--</strong>
            </div>
            <div class="run-meta">
              <span>最新观测时间</span>
              <strong id="healthTimeliness">--</strong>
            </div>
            <div class="run-meta">
              <span>是否可执行</span>
              <strong id="healthQuality">--</strong>
            </div>
            <div class="run-meta">
              <span>模型稳定性</span>
              <strong id="healthDrift">--</strong>
            </div>
            <div class="run-meta">
              <span>交易摩擦</span>
              <strong id="healthExecution">--</strong>
            </div>
            <div class="run-meta">
              <span>ETA</span>
              <strong id="etaValue">--</strong>
            </div>
          </div>
          <div class="run-bar-meta" id="runMetaRight">
            <div class="run-meta">
              <span>Run ID</span>
              <strong id="runMetaId">--</strong>
            </div>
            <div class="run-meta">
              <span>运行时间（本地）</span>
              <strong id="runMetaTime">--</strong>
            </div>
            <div class="run-meta">
              <span>数据时间（抓取）</span>
              <strong id="runMetaDataTime">--</strong>
            </div>
            <div class="run-meta">
              <span>来源</span>
              <strong id="runMetaSource">--</strong>
            </div>
            <div class="run-meta">
              <span>可信度</span>
              <strong id="runMetaTrust">--</strong>
            </div>
            <div class="run-meta">
              <span>自动任务状态</span>
              <strong id="runMetaDailyStatus">--</strong>
            </div>
            <div class="run-meta">
              <span>自动完成时间</span>
              <strong id="runMetaDailyAt">--</strong>
            </div>
          </div>
        </div>
        <div class="run-bar-steps">
          <div class="run-step">
            <span>抓取</span>
            <strong id="runStageFetch">待运行</strong>
          </div>
          <div class="run-step">
            <span>校验</span>
            <strong id="runStageValidate">待运行</strong>
          </div>
          <div class="run-step">
            <span>计算</span>
            <strong id="runStageCompute">待运行</strong>
          </div>
          <div class="run-step">
            <span>回放</span>
            <strong id="runStageReplay">待运行</strong>
          </div>
          <div class="run-step">
            <span>AI</span>
            <strong id="runStageAi">待运行</strong>
          </div>
        </div>
        <div class="run-advice" id="runAdvice">
          <div class="run-advice-title">运行诊断与建议</div>
          <div class="run-advice-body" id="runAdviceBody">待运行：点击“今日运行”开始。</div>
          <div class="run-advice-actions">
            <button id="quickFetchBtn" class="ghost" type="button">自动抓取（本地优先）</button>
            <button id="quickForceFetchBtn" class="ghost" type="button">强制抓取（外部刷新）</button>
            <button id="quickRerunBtn" class="ghost" type="button">重试今日运行</button>
          </div>
        </div>
      </section>

      <section class="panel decision-panel stage-marker stage-decision" id="decisionPanel" data-layout-mode="decision">
        <div class="panel-title">决策总览（先看）</div>
        <div class="decision-grid">
          <div class="decision-card">
            <div class="decision-label">当前结论</div>
            <div class="decision-value" id="decisionConclusion">--</div>
            <div class="decision-sub" id="decisionWhy">--</div>
          </div>
          <div class="decision-card">
            <div class="decision-label">是否可执行</div>
            <div class="decision-value" id="decisionExecutable">--</div>
            <div class="decision-sub">由可信度、时效、模型稳定性、交易摩擦共同决定</div>
          </div>
          <div class="decision-card">
            <div class="decision-label">下一步看什么</div>
            <div class="decision-sub" id="decisionNext">--</div>
          </div>
          <div class="decision-card decision-card-wide" id="predictionSummaryCard">
            <div class="decision-label">预测闭环摘要</div>
            <div class="decision-sub" id="predictionSummaryValue">--</div>
            <div class="decision-actions">
              <button id="predictionSummaryEvalBtn" class="ghost" type="button">查看评估</button>
              <button id="predictionSummaryIterBtn" class="ghost" type="button">查看迭代建议</button>
            </div>
          </div>
        </div>
      </section>

      <section class="panel timeline-panel stage-marker stage-explain" id="timelinePanel" data-layout-mode="explain" data-mobile-collapsible="true">
        <div class="panel-title">时间轴总览</div>
        <div class="timeline-overview" id="timelineOverview"></div>
        <div class="timeline-tooltip" id="timelineTooltip">--</div>
        <div class="timeline-legend" id="timelineLegend"></div>
        <div class="timeline-track">
          <input type="range" id="timelineRange" min="0" max="0" value="0" />
          <div class="timeline-meta">
            <div class="timeline-label" id="timelineLabel">--</div>
            <button class="ghost" id="timelineLatestBtn">回到今天</button>
          </div>
        </div>
        <div class="history-track">
          <div class="history-title">历史日期轴（365天）</div>
          <input type="range" id="historyRange" min="0" max="0" value="0" />
          <div class="history-meta">
            <input type="date" id="historyDate" />
            <div class="history-hint" id="historyHint">选择日期将自动抓取并回放</div>
          </div>
        </div>
      </section>

      <section class="panel status-panel stage-marker stage-explain" id="statusPanel" data-layout-mode="explain" data-mobile-collapsible="true" data-mobile-label="状态看板">
        <div class="status-core">
          <div class="status-pill" id="statusBadge">B</div>
          <div>
            <div class="status-title" id="statusTitle">B / 防守档</div>
            <div class="status-sub" id="statusSub">默认防守，等待确认</div>
          </div>
        </div>
        <div class="status-overview" id="statusOverview"></div>
        <div class="status-grid">
          <div class="stat">
            <div class="stat-label">β / β_cap</div>
            <div class="stat-value" id="betaValue">0.45 / 0.60</div>
          </div>
          <div class="stat">
            <div class="stat-label">对冲</div>
            <div class="stat-value" id="hedgeValue">OFF</div>
          </div>
          <div class="stat">
            <div class="stat-label">SC-Phase</div>
            <div class="stat-value" id="phaseValue">Up-Mid</div>
          </div>
          <div class="stat">
            <div class="stat-label">相位置信度</div>
            <div class="stat-value" id="confidenceValue">0.62</div>
          </div>
          <div class="stat">
            <div class="stat-label">极限重仓许可</div>
            <div class="stat-value" id="extremeValue">否</div>
          </div>
          <div class="stat">
            <div class="stat-label">分发闸门</div>
            <div class="stat-value" id="distributionValue">0 / 30D</div>
          </div>
        </div>
        <div class="key-evidence" id="keyEvidence"></div>
      </section>

      <section class="panel gate-audit-panel stage-marker stage-audit" id="gateAuditPanel" data-layout-mode="audit" data-mobile-collapsible="true">
        <div class="panel-title">闸门链路 · 审计面板</div>
        <div class="gate-audit-grid">
          <div class="gate-chain" id="gateChain"></div>
          <div class="audit-visual" id="auditVisual"></div>
        </div>
      </section>

      <section class="panel action-panel stage-marker stage-decision" id="actionPanel" data-layout-mode="decision">
        <div class="panel-title">行动映射 · 风险与反证</div>
        <div class="action-block">
          <div class="action-label">建议动作</div>
          <div class="action-value" id="actionSummary">--</div>
          <div class="action-sub" id="actionDetail">--</div>
        </div>
        <div class="action-block">
          <div class="action-label">不要做什么</div>
          <div class="action-list" id="actionAvoid">--</div>
        </div>
        <div class="action-block">
          <div class="action-label">下一步验证点</div>
          <div class="action-list" id="actionWatch">--</div>
        </div>
        <div class="action-block">
          <div class="action-label">反证条件</div>
          <div class="action-list" id="counterfactuals">--</div>
        </div>
        <div class="action-block">
          <div class="action-label">缺失影响</div>
          <div class="action-list" id="missingImpact">--</div>
        </div>
      </section>

      <section class="panel kanban stage-marker stage-audit" data-layout-mode="audit" data-mobile-collapsible="true">
        <div class="panel-title">状态看板</div>
        <div class="kanban-grid">
          <div class="kanban-col" data-state="A">
            <div class="kanban-head">A / 进攻档</div>
            <div class="kanban-body" id="kanbanA"></div>
          </div>
          <div class="kanban-col" data-state="B">
            <div class="kanban-head">B / 防守档</div>
            <div class="kanban-body" id="kanbanB"></div>
          </div>
          <div class="kanban-col" data-state="C">
            <div class="kanban-head">C / 避险档</div>
            <div class="kanban-body" id="kanbanC"></div>
          </div>
        </div>
      </section>

      <section class="panel gateflow stage-marker stage-audit" data-layout-mode="audit" data-mobile-collapsible="true">
        <div class="panel-title">闸门链路 · 逐步可审计</div>
        <div class="gate-track" id="gateList"></div>
      </section>

      <section class="panel inspector stage-marker stage-audit" data-layout-mode="audit" data-mobile-collapsible="true">
        <div class="panel-title">审计面板</div>
        <div id="gateInspector" class="inspector-body">
          <div class="inspector-empty">点击任意闸门，查看输入、来源与计算过程。</div>
        </div>
      </section>

      <section class="panel reasons stage-marker stage-explain" id="reasonsPanel" data-layout-mode="explain">
        <div class="panel-title">证据摘要 · Top3 驱动</div>
        <ol id="topReasons" class="reason-list"></ol>
        <div class="panel-title">危险信号与结构注记</div>
        <div id="riskNotes" class="notes"></div>
        <div class="panel-title">证据提示</div>
        <div class="notes" id="evidenceHints">--</div>
      </section>

      <section class="panel ai-panel stage-marker stage-audit" id="aiPanelSection" data-layout-mode="audit" data-mobile-collapsible="true">
        <div class="panel-title">AI 解读</div>
        <div class="ai-status" id="aiStatus">AI 未联机，已使用本地解读</div>
        <div id="aiPanel" class="ai-body"></div>
      </section>

      <section class="panel trend stage-marker stage-explain" id="trendPanel" data-layout-mode="explain" data-mobile-collapsible="true">
        <div class="panel-title">历史趋势</div>
        <div class="trend-grid">
          <div class="trend-card">
            <div class="trend-label">β 趋势</div>
            <div class="trend-chart" id="betaChart"></div>
            <div class="trend-meta" id="betaTrendMeta">反映仓位进攻/防守倾向，数值越高越进攻。</div>
          </div>
          <div class="trend-card">
            <div class="trend-label">置信度趋势</div>
            <div class="trend-chart" id="confidenceChart"></div>
            <div class="trend-meta" id="confidenceTrendMeta">反映当前判断稳定性，越高说明信号一致性越强。</div>
          </div>
          <div class="trend-card">
            <div class="trend-label">FoF 趋势</div>
            <div class="trend-chart" id="fofChart"></div>
            <div class="trend-meta" id="fofTrendMeta">反映流动性环境，偏低通常意味着资金面偏紧。</div>
          </div>
        </div>
      </section>

      <section class="panel eval-panel stage-marker stage-explain" id="evalPanelSection" data-layout-mode="explain" data-mobile-collapsible="true">
        <div class="panel-title">预测评估 · 是否可执行</div>
        <div class="eval-actions">
          <button id="backfill90Btn" class="ghost" type="button">回测补齐 90 天</button>
          <button id="backfill180Btn" class="ghost" type="button">回测补齐 180 天</button>
          <button id="backfill365Btn" class="ghost" type="button">回测补齐 365 天</button>
          <div id="evalBackfillStatus" class="eval-backfill-status">可选：先补齐历史样本，再看命中率。</div>
        </div>
        <div id="evalPanel" class="eval-body"></div>
      </section>

      <section class="panel iteration-panel stage-marker stage-explain" id="iterationPanelSection" data-layout-mode="explain" data-mobile-collapsible="true">
        <div class="panel-title">迭代建议 · 自动生成</div>
        <div class="iteration-meta" id="iterationMeta">--</div>
        <pre class="iteration-body" id="iterationBody">今日尚未生成迭代建议。</pre>
      </section>

      <section class="panel data-panel stage-marker stage-data" id="dataPanelSection" data-layout-mode="data" data-mobile-collapsible="true">
        <div class="panel-title">数据台 · 自动抓取与输入</div>
        <div class="workflow">
          <div class="workflow-step">
            <div class="workflow-label">抓取</div>
            <div class="workflow-value" id="workflowFetch">待运行</div>
          </div>
          <div class="workflow-step">
            <div class="workflow-label">校验</div>
            <div class="workflow-value" id="workflowValidate">待运行</div>
          </div>
          <div class="workflow-step">
            <div class="workflow-label">运行</div>
            <div class="workflow-value" id="workflowRun">待运行</div>
          </div>
          <div class="workflow-step">
            <div class="workflow-label">回放</div>
            <div class="workflow-value" id="workflowReplay">待运行</div>
          </div>
        </div>
        <div class="data-actions">
          <span class="mode-pill">自动模式（本地历史优先 + 半衰期治理）</span>
          <label class="toggle">
            <span>运行日期</span>
            <input type="date" id="runDate" />
          </label>
          <button id="fetchBtn" class="ghost">自动抓取</button>
          <button id="forceFetchBtn" class="ghost">强制抓取</button>
        </div>
        <div id="sourceStatus" class="source-status"></div>
        <div id="inputError" class="input-error"></div>
        <div class="data-hint">
          规则：数据不完整将严格阻止运行。请先自动抓取，再补齐缺失项。
        </div>
        <div class="data-purpose">
          本区用于“抓取 + 校验 + 回填 + 导出”。系统默认自动抓取并优先使用本地历史补齐，
          同时对超半衰期字段执行拦截，避免过期数据污染判断。手动输入路径已默认关闭。
        </div>
        <details class="mobile-fold" id="rawJsonFold" open>
          <summary>
            <span class="mobile-fold-title">原始 JSON（只读）</span>
            <span class="mobile-fold-meta">点击展开/收起</span>
          </summary>
          <textarea id="inputJson" class="data-textarea" rows="12" spellcheck="false" readonly></textarea>
        </details>
        <div class="data-buttons">
          <button id="exportJsonBtn" class="ghost">导出 JSON</button>
          <button id="exportCsvBtn" class="ghost">导出 CSV</button>
        </div>
        <details class="mobile-fold" id="coverageFold" open>
          <summary>
            <span class="mobile-fold-title">数据覆盖矩阵</span>
            <span class="mobile-fold-meta">默认展开（移动端默认收起）</span>
          </summary>
          <div class="panel-title desktop-fold-title">数据覆盖矩阵</div>
          <div class="coverage-controls">
            <input id="coverageSearch" class="coverage-search" type="search" placeholder="搜索字段（如 dxy / ETF / 映射）" />
            <select id="coverageFilter" class="coverage-filter" aria-label="覆盖矩阵过滤">
              <option value="all">全部</option>
              <option value="key">关键证据</option>
              <option value="missing">缺失</option>
              <option value="aging">衰减</option>
              <option value="stale">过期</option>
            </select>
            <button id="coverageClearBtn" class="ghost" type="button">清除</button>
          </div>
          <div id="coverageList" class="coverage-grid"></div>
          <div class="data-hint">点击闸门可追溯输入与规则命中。覆盖矩阵按闸门分组显示来源与用途。</div>
        </details>
      </section>
    </main>

    <nav id="mobileTabbar" class="mobile-tabbar" role="tablist" aria-label="移动端分层导航">
      <button class="mobile-tab" type="button" role="tab" data-tab="decision" aria-selected="true">决策</button>
      <button class="mobile-tab" type="button" role="tab" data-tab="explain" aria-selected="false">解读</button>
      <button class="mobile-tab" type="button" role="tab" data-tab="audit" aria-selected="false">审计</button>
      <button class="mobile-tab" type="button" role="tab" data-tab="data" aria-selected="false">数据</button>
    </nav>

    <button id="runFloatingBtn" class="cta cta-floating" type="button" aria-label="今日运行（悬浮按钮）">
      <span class="cta-floating-dot" aria-hidden="true"></span>
      <span class="cta-floating-main">今日运行</span>
      <span class="cta-floating-sub"><span id="runFloatingEta">--</span></span>
    </button>

    <footer class="footer">
      <div>ETH-A Dashboard Trend · 本地运行 / 自动抓取</div>
      <button id="clearBtn" class="ghost">清空历史</button>
    </footer>

    <script>
      (function () {
        var warning = document.getElementById("fileWarning");
        if (window.location.protocol === "file:") {
          warning.style.display = "flex";
        }
      })();
    </script>
    <script type="module" src="app.js?v=20260219-1"></script>
  </body>
</html>
